<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard | Mentor Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script>
    window.MENTOR_TRACKER_CLIENT_ID = "470142220043-4pm52ffc5gapjdgtplf6uim5t5o1juj7.apps.googleusercontent.com";
    window.MENTOR_TRACKER_AUTH_OPTIONS = {
      allowedDomain: "nmamit.in",
      allowedEmails: ["jason1987martis@nitte.edu.in"]
    };
  </script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="auth-helper.js" defer></script>

  <!-- Plotly.js CDN -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #ffffff);
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* === Top Navigation === */
    .top-nav {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      background: #2a348d;
      border-radius: 16px;
      padding: 0.75rem 1.5rem;
      border: 4px solid rgba(42, 52, 141, 0.2);
      box-shadow: 0 6px 18px rgba(42, 52, 141, 0.3);
    }

    .top-nav a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      padding: 0.55rem 1rem;
      border-radius: 10px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .top-nav a:hover,
    .top-nav a:focus {
      background-color: rgba(255, 255, 255, 0.18);
      transform: translateY(-1px);
      outline: none;
    }

    .top-nav .active {
      background-color: rgba(255, 255, 255, 0.3);
      color: #2a348d;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      background: #fff;
      padding: 2rem 2.5rem;
      border-radius: 20px;
      border: 6px solid #2a348d;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      width: 90px;
      display: block;
      margin: 0 auto 1rem auto;
    }

    h1 {
      text-align: center;
      color: #0d47a1;
      font-weight: 700;
      margin-bottom: 2rem;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 1rem;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.3rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      transition: 0.3s;
    }

    input:focus {
      border-color: #1976d2;
      box-shadow: 0 0 5px rgba(25, 118, 210, 0.3);
      outline: none;
    }

    button {
      margin-top: 1.5rem;
      padding: 0.8rem 1.5rem;
      background: #2a348d;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      display: block;
      width: 60%;
      margin-left: auto;
      margin-right: auto;
      transition: 0.3s;
      box-shadow: 0 4px 10px rgba(21, 101, 192, 0.25);
    }

    button:hover {
      background-color: #0d47a1;
      transform: translateY(-2px);
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      background: rgba(42, 52, 141, 0.1);
      color: #2a348d;
      text-decoration: none;
      font-weight: 600;
      padding: 0.4rem 0.95rem 0.4rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(42, 52, 141, 0.25);
      box-shadow: 0 4px 12px rgba(42, 52, 141, 0.2);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
      margin-bottom: 1rem;
      width: fit-content;
    }

    .back-btn .back-icon {
      display: inline-grid;
      place-items: center;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #2a348d;
      color: #ffffff;
      font-size: 1.05rem;
      line-height: 1;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.15);
    }

    .back-btn:hover,
    .back-btn:focus {
      background-color: rgba(42, 52, 141, 0.18);
      box-shadow: 0 6px 16px rgba(42, 52, 141, 0.25);
      transform: translateY(-1px);
      outline: none;
    }

    .error {
      color: red;
      font-weight: 600;
      text-align: center;
      margin-top: 1rem;
      min-height: 1.5rem;
    }

    /* Loader used in status message */
    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid #bbdefb;
      border-top-color: #2a348d;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .summary {
      display: flex;
      justify-content: space-around;
      background: #e3f2fd;
      border-radius: 10px;
      padding: 1rem;
      margin: 1.5rem 0;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .summary div {
      text-align: center;
      color: #2a348d;
      font-weight: 600;
    }

    .toggle-btn {
      background: #2a348d;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      font-weight: 600;
      cursor: pointer;
      display: block;
      margin: 1.5rem auto;
      transition: 0.3s ease;
      box-shadow: 0 4px 10px rgba(21, 101, 192, 0.25);
    }

    .toggle-btn:hover {
      background: #0d47a1;
      transform: translateY(-2px);
    }

    .collapsible {
      display: none;
      opacity: 0;
      transition: all 0.6s ease;
    }

    .collapsible.active {
      display:block;
      opacity: 1;
      transition: all 0.8s ease;
    }

    .chart-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 1.5rem;
      margin: 2rem auto;
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
    }

    #summaryContainer { margin-bottom: 2rem; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.7rem;
      text-align: left;
    }

    th {
      background-color: #e3f2fd;
      color: #2a348d;
    }

    tr:hover td {
      background: #f9f9f9;
    }

    @media (max-width: 600px) {
      body {
        padding: 1.5rem 1rem;
        gap: 1rem;
      }
      .top-nav {
        gap: 0.5rem;
        padding: 0.75rem 1rem;
      }
      .top-nav a {
        flex: 1 1 130px;
      }
      .container { padding: 1.5rem; }
      button { width: 100%; }
      .summary { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>
  <nav class="top-nav" aria-label="Main navigation">
    <a href="index.html" data-keep-query>Home</a>
    <a href="register.html" data-keep-query>Register</a>
    <a href="academic.html" data-keep-query>Academic</a>
    <a href="activities.html" data-keep-query>Activities</a>
    <a href="meeting.html" data-keep-query>Meetings</a>
    <a href="viewdash.html" class="active" data-keep-query>Dashboard</a>
  </nav>

  <div class="container" data-auth-required>
    <a href="index.html" class="back-btn" data-keep-query onclick="if (window.history.length > 1) { window.history.back(); return false; }">
      <span class="back-icon" aria-hidden="true">&#8592;</span>
      <span>Back</span>
    </a>
    <img src="logo.jpg" alt="Nitte Logo" class="logo" />
    <h1>Student Dashboard</h1>

    <label for="usn">USN:</label>
    <input type="text" id="usn" placeholder="Enter your USN" />
    <label for="accessKey">Access Key:</label>
    <input type="text" id="accessKey" placeholder="Enter your Access Key" />
    <button onclick="loadDashboard()" id="dashviewer">View Dashboard</button>
    <div id="errorMsg" class="error"></div>

    

    <!-- Full Dashboard Sections -->
    <div id="dashboard" style="display:none;">
      <div id="personalInfo" class="section"></div>
      <!-- Summary & Charts -->
    <div id="summaryWrapper" style="display:none;">
      <button id="toggleSummary" class="toggle-btn" onclick="toggleSummarySection()">Show Summary & Charts</button>

      <div id="summaryContainer" class="collapsible">
        <div class="summary">
          <div id="totalSems">Total Semesters: 0</div>
          <div id="avgSGPA">Average SGPA: -</div>
          <div id="totalActivities">Total Activity Points: 0</div>
        </div>

        <div class="chart-card">
          <h3 style="text-align:center; color:#0d47a1;">SGPA per Semester</h3>
          <div id="sgpaChart"></div>
        </div>

        <div class="chart-card">
          <h3 style="text-align:center; color:#0d47a1;">Activity Points per Semester</h3>
          <div id="activityChart"></div>
        </div>
      </div>
    </div>
      <div id="academicInfo" class="section"></div>
      <div id="activitiesInfo" class="section"></div>
      <div id="meetingsInfo" class="section"></div>
    </div>
  </div>

<script src="config-helper.js"></script>
<script>
const config = window.MENTOR_TRACKER_CONFIG || {};
const apiUrl = config.apiUrl || "https://script.google.com/macros/s/AKfycbzRMrKi2BFLuEhIs4NJx3XwDgKwNomCPpWlxH9C64tDcAMskkziUcSHXgWSL3ZgNUvE/exec";

async function loadDashboard() {
  const usn = document.getElementById("usn").value.trim();
  const button = document.getElementById("dashviewer");
  const accessKey = document.getElementById("accessKey").value.trim();
  const errorMsg = document.getElementById("errorMsg");
  button.disabled = true;

  if (!usn || !accessKey) {
    errorMsg.textContent = "Please enter both USN and Access Key.";
    button.disabled = false;
    return;
  }

  errorMsg.innerHTML = '<span class="loader"></span>Fetching Records. Please Wait...';

  try {
    const res = await MENTOR_TRACKER_secureFetch(`${apiUrl}?formType=dashboard&usn=${encodeURIComponent(usn)}&accessKey=${encodeURIComponent(accessKey)}`);
    const data = await res.json();

    if (!data.success) {
      errorMsg.textContent = data.error || "Access denied or data not found.";
      button.disabled = false;
      return;
    }

    document.getElementById("dashboard").style.display = "block";
    document.getElementById("summaryWrapper").style.display = "block";
    document.getElementById("summaryContainer").classList.add("active");
    document.getElementById("summaryContainer").style.display = "block";
    document.getElementById("toggleSummary").textContent = "Hide Summary & Charts";

    renderPersonalInfo(data.personal || {});
    renderAcademicInfo(data.academic || {});
    renderActivities(data.activities || {});
    renderMeetings(data.meetings || {});
    computeAndDisplaySummary(data.academic || {}, data.activities || {});

    errorMsg.textContent = "Records fetched successfully!";
  } catch (err) {
    console.error(err);
    errorMsg.textContent = "Something went wrong. Please try again later.";
  }
  button.disabled = false;
}

/* === SUMMARY AND PLOTLY CHARTS === */
function computeAndDisplaySummary(academic, activities) {
  const sgpaData = {}, activityPoints = {};
  const semesters = Array.from(new Set([...Object.keys(academic || {}), ...Object.keys(activities || {})]))
    .map(Number)
    .filter(n => !Number.isNaN(n))
    .sort((a, b) => a - b);

  semesters.forEach(sem => {
    const subjects = academic[sem] || [];
    let totalCredits = 0, weightedSum = 0;
    subjects.forEach(s => {
      const gp = parseFloat(s["Grade Point"] ?? s["Grade Point "] ?? 0);
      const cr = parseFloat(s["Credits"] ?? s["Credit"] ?? 0);
      if (!isNaN(gp) && !isNaN(cr)) {
        weightedSum += gp * cr;
        totalCredits += cr;
      }
    });
    sgpaData[sem] = totalCredits > 0 ? Number((weightedSum / totalCredits).toFixed(2)) : 0;

    const acts = activities[sem] || [];
    let totalAct = 0;
    acts.forEach(a => {
      const pts = parseFloat(a["Credit Points"] ?? a["Activity Points (Consult Mentor)"] ?? 0);
      if (!isNaN(pts)) totalAct += pts;
    });
    activityPoints[sem] = totalAct;
  });

  const totalSems = semesters.length;
  const avgSGPA = totalSems > 0 
    ? (Object.values(sgpaData).reduce((a, b) => a + Number(b || 0), 0) / totalSems).toFixed(2)
    : "-";
  const totalActivity = Object.values(activityPoints).reduce((a, b) => a + Number(b || 0), 0);

  document.getElementById("totalSems").textContent = `Total Semesters: ${totalSems}`;
  document.getElementById("avgSGPA").textContent = `Average SGPA: ${avgSGPA}`;
  document.getElementById("totalActivities").textContent = `Total Activity Points: ${totalActivity}`;

  renderPlotlyCharts(semesters, sgpaData, activityPoints);
}

/* === PLOTLY CHARTS === */
function renderPlotlyCharts(semesters, sgpaData, activityPoints) {
  const sgpaY = semesters.map(s => Number(sgpaData[s] ?? 0));
  const actY = semesters.map(s => Number(activityPoints[s] ?? 0));

  // SGPA Chart
  const sgpaTrace = {
    x: semesters,
    y: sgpaY,
    type: 'bar',
    marker: { color: 'rgba(25,118,210,0.8)' },
    name: 'SGPA',
    text: sgpaY.map(v => v.toFixed(2)),
    textposition: 'auto'
  };
  const sgpaLayout = {
    title: 'SGPA per Semester',
    margin: { t: 40, b: 50, l: 50, r: 20 },
    yaxis: { title: 'SGPA', range: [0, 10] },
    xaxis: { title: 'Semester' },
    paper_bgcolor: '#fff',
    plot_bgcolor: '#fff'
  };
  Plotly.newPlot('sgpaChart', [sgpaTrace], sgpaLayout, { responsive: true });

  // Activity Chart
  const actTrace = {
    x: semesters,
    y: actY,
    type: 'bar',
    marker: { color: 'rgba(46,204,113,0.8)' },
    name: 'Activity Points',
    text: actY.map(v => v),
    textposition: 'auto'
  };
  const maxTrace = {
    x: semesters,
    y: semesters.map(() => 25),
    type: 'bar',
    name: 'Max Points (25)',
    marker: { color: 'rgba(200,200,200,0.4)' }
  };
  const actLayout = {
    title: 'Activity Points per Semester',
    margin: { t: 40, b: 50, l: 50, r: 20 },
    yaxis: { title: 'Activity Points', range: [0, 30] },
    xaxis: { title: 'Semester' },
    barmode: 'group',
    paper_bgcolor: '#fff',
    plot_bgcolor: '#fff'
  };
  Plotly.newPlot('activityChart', [actTrace, maxTrace], actLayout, { responsive: true });
}

/* === COLLAPSIBLE SECTION === */
function toggleSummarySection() {
  const summaryContainer = document.getElementById("summaryContainer");
  const toggleBtn = document.getElementById("toggleSummary");
  const isActive = !summaryContainer.classList.contains("active");
  summaryContainer.classList.toggle("active", isActive);
  summaryContainer.style.display = isActive ? "block" : "none";
  toggleBtn.textContent = isActive ? "Hide Summary & Charts" : "Show Summary & Charts";
}

/* === TABLE RENDERING FUNCTIONS === */
function renderPersonalInfo(info) {
  const c = document.getElementById("personalInfo");
  c.innerHTML = `<h2>Personal Information</h2>`;
  const t = document.createElement("table");
  t.innerHTML = `<tr><th>Field</th><th>Value</th></tr>`;
  for (const k in info) {
    const val = info[k] ?? "";
    t.innerHTML += `<tr><td>${escapeHTML(k)}</td><td>${escapeHTML(String(val))}</td></tr>`;
  }
  c.appendChild(t);
}

function renderAcademicInfo(academic) {
  const c = document.getElementById("academicInfo");
  c.innerHTML = `<h2>Academic Records</h2>`;
  for (const sem in academic) {
    const s = document.createElement("div");
    s.innerHTML = `<h3>Semester ${escapeHTML(sem)}</h3>`;
    const t = document.createElement("table");
    const r = academic[sem] || [];
    if (r.length > 0) {
      const h = Object.keys(r[0]);
      t.innerHTML = `<tr>${h.map(x => `<th>${escapeHTML(x)}</th>`).join('')}</tr>`;
      r.forEach(d => {
        t.innerHTML += `<tr>${h.map(x => `<td>${escapeHTML(String(d[x] ?? ""))}</td>`).join('')}</tr>`;
      });
    }
    s.appendChild(t);
    c.appendChild(s);
  }
}

function renderActivities(acts) {
  const c = document.getElementById("activitiesInfo");
  c.innerHTML = `<h2>Activities</h2>`;
  for (const sem in acts) {
    const s = document.createElement("div");
    s.innerHTML = `<h3>Semester ${escapeHTML(sem)}</h3>`;
    const t = document.createElement("table");
    const r = acts[sem] || [];
    if (r.length > 0) {
      const h = Object.keys(r[0]);
      t.innerHTML = `<tr>${h.map(x => `<th>${escapeHTML(x)}</th>`).join('')}</tr>`;
      r.forEach(d => {
        t.innerHTML += `<tr>${h.map(x => {
          const val = d[x];
          if (String(x).toLowerCase().includes("proof")) {
            const href = typeof val === "string" ? val : "";
            const safeHref = encodeURI(href);
            return `<td>${href ? `<a href="${safeHref}" target="_blank" rel="noopener noreferrer">View Proof</a>` : ""}</td>`;
          }
          return `<td>${escapeHTML(String(val ?? ""))}</td>`;
        }).join('')}</tr>`;
      });
    }
    s.appendChild(t);
    c.appendChild(s);
  }
}

function renderMeetings(m) {
  const c = document.getElementById("meetingsInfo");
  c.innerHTML = `<h2>Mentor Meetings</h2>`;
  for (const sem in m) {
    const s = document.createElement("div");
    s.innerHTML = `<h3>Semester ${escapeHTML(sem)}</h3>`;
    const t = document.createElement("table");
    const r = m[sem] || [];
    if (r.length > 0) {
      const h = Object.keys(r[0]);
      t.innerHTML = `<tr>${h.map(x => `<th>${escapeHTML(x)}</th>`).join('')}</tr>`;
      r.forEach(d => {
        t.innerHTML += `<tr>${h.map(x => `<td>${escapeHTML(String(d[x] ?? ""))}</td>`).join('')}</tr>`;
      });
    }
    s.appendChild(t);
    c.appendChild(s);
  }
}

/* === Small HTML escaper for safety === */
function escapeHTML(str) {
  return str
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}
</script>
</body>
</html>


